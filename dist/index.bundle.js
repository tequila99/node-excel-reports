!function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=10)}([function(e,t){e.exports=require("express")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("xlsx-populate")},function(e,t){e.exports=require("multer")},function(e,t){e.exports=require("nanoid/async/generate")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("date-and-time")},function(e,t){e.exports=require("jsdom")},function(e,t){e.exports=require("fs")},function(e,t,r){r(11),e.exports=r(12)},function(e,t){e.exports=require("regenerator-runtime/runtime")},function(e,t,r){"use strict";r.r(t);var a=r(0),n=r.n(a),s=r(5),o=r.n(s),l=r(6),i=r.n(l);class u extends Error{constructor(e,t){super(e),this.name=this.constructor.name,this.statusCode=t,Error.captureStackTrace(this,u)}}class c{static log(e){console.error(e)}static createSuccessResponse(e,t={}){return{data:e,meta:t,status:"success"}}static createErrorResponse(e,t={}){c.log(e);let r,a="";return e instanceof Error&&(a=e.message,r=e.statusCode),"string"==typeof e&&(a=e),Array.isArray(e.details)&&(a=e.details[0].message),r||(r=500),a||(a="Server Error"),{message:a,status:"error",statusCode:r,meta:t}}static requestHandler(e){return async(t,r,a)=>{try{const n=await e.call(null,t,r,a);r.json(c.createSuccessResponse(n))}catch(e){const{statusCode:t,...a}=c.createErrorResponse(e);r.status(t).json(a)}}}}const p=n.a.Router();p.get("/ping",c.requestHandler.call(null,async()=>"Ok"));var m=p,y=r(3),f=r.n(y);const h=f.a.diskStorage({destination:"uploads/",filename:(e,t,r)=>{r(null,`${Date.now()}-${t.originalname}`)}}),d=f()({storage:h}),w=n.a.Router();w.post("/",async(e,t,r)=>d.single("filename")(e,t,r),c.requestHandler.call(null,async e=>{if(!e.file)throw new u("Произошла ошибка при загрузке файла");return e.file}));var b=w,v=r(2),g=r.n(v),x=r(7),T=r.n(x);const R=e=>{if("valueType"in e){const t=S(e),r=E(e);if(t){if("money"===e.valueType)return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",currencyDisplay:"symbol",useGrouping:!1}).format(r);if("numeric"===e.valueType){const[,e=""]=t.split(".");return new Intl.NumberFormat("ru-RU",{style:"decimal",useGrouping:!1,minimumFractionDigits:e.length,maximumFractionDigits:e.length}).format(r)}if("date"===e.valueType){let e;return e="mm"===t.slice(-2)?`${t.slice(0,t.length-2).toUpperCase()}hh`:t.toUpperCase(),T.a.format(r,e)}return`${r}`}return r}return e.value},E=e=>{if("valueType"in e){let t=e.value;if("integer"===e.valueType)try{t=parseInt(e.value,10)}catch(t){throw new u(`Невозможно привести тип данных ${e.value} к целому типу`)}else if("money"===e.valueType||"numeric"===e.valueType)try{t=+e.value}catch(t){throw new u(`Невозможно привести тип данных ${e.value} к числовому типу`)}else if("date"===e.valueType)try{t=new Date(e.value)}catch(t){throw new u(`Невозможно привести тип данных ${e.value} к типу дата`)}return t}return e.value||""},S=e=>"valueType"in e?"integer"===e.valueType?"0":"money"===e.valueType?"0.00":"numeric"===e.valueType?e.format||"0.00":"date"===e.valueType?e.format||"dd.mm.yyyy":e.format||"":e.format||"";var H=class{constructor(){this.wb=null}get workbook(){return this.wb}async loadTemplate(e){this.wb=void 0===e?await g.a.fromBlankAsync():"string"==typeof e?await g.a.fromFileAsync(e):await g.a.fromDataAsync(e)}async toBuffer(){return this.wb.outputAsync()}async toFile(e){return this.wb.toFileAsync(e)}applyData(e={}){if(!this.wb)throw new u("Шаблон XLSX не загружен");if(!Object.keys(e).length)throw new u("Отсутсвуют данные для заполнения шаблона XLSX");const{params:t=[],data:r=[]}=e;t.forEach(e=>this.applyParam(e)),r.length&&this.wb.find("<TABLE>").slice(0,1).forEach(e=>{r.forEach((t,r)=>{t.forEach((t,a)=>{const n=e.relativeCell(r,a),s=E(t),o=S(t);n.value(s),o&&n.style("numberFormat",o),n.style("border",t.border||!0),this.applyStyle(n,t)})})}),this.clearUnusedParam()}applyParam(e={}){this.wb.find(`<${e.key}>`).forEach(t=>{if(t.value()===`<${e.key}>`){const r=E(e),a=S(e);t.value(r),a&&t.style("numberFormat",a),this.applyStyle(t,e)}else{const r=R(e),a=new RegExp(`<${e.key}>`,"g");t.value(t.value().replace(a,r))}})}clearUnusedParam(){this.wb.find(/<.*>/).forEach(e=>{e.value(e.value().replace(/<.*>/g,""))})}applyStyle(e,t){"styles"in t&&Object.keys(t).forEach(r=>{e.style(r,t[r])})}},j=r(8),q=r(9),$=r.n(q);var k=class{constructor(){this.dom=null,this.document=null,this.tableRow=null,this.templateRow=null,this.textHtml=null}async loadTemplate(e){const t=await j.JSDOM.fromFile(e),{window:{document:r}}=t;this.dom=t,this.document=r,this.tableRow=r.querySelector(".data-table-row"),this.templateRow=this.tableRow.innerHTML}async toFile(e){return new Promise((t,r)=>{$.a.writeFile(e,this.textHtml,e=>{e?r(e):t(!0)})})}applyData(e={}){if(!this.dom)throw new u("Шаблон HTML не загружен");if(!Object.keys(e).length)throw new u("Отсутсвуют данные для заполнения шаблона HTML");const{params:t=[],data:r=[]}=e;r.length&&this.applyTable(r),this.textHtml=this.dom.serialize(),t.forEach(e=>this.applyParam(e));const a=new RegExp("{{.*}}","gi");this.textHtml=this.textHtml.replace(a,"")}applyParam(e={}){const t=R(e),r=new RegExp(`{{\\s*${e.key}\\s*}}`,"gi");this.textHtml=this.textHtml.replace(r,t)}applyTable(e=[]){if(!e.length)throw new u("Отстутсвуют данные таблицы для заполнения шаблна HTML");if(!this.tableRow)throw new u("В шаблоне HTML отсутсвует таблица для заполнения");e.forEach((e,t)=>{let r=this.templateRow;if(e.forEach((e,t)=>{const a=R(e),n=new RegExp(`{{\\s*col-${t+1}\\s*}}`,"i");r=r.replace(n,a)}),t){const e=this.document.createElement("tr");e.innerHTML=r,this.tableRow.parentNode.insertBefore(e,this.tableRow.nextSibling)}else this.tableRow.innerHTML=r})}},O=r(4),P=r.n(O),F=r(1),M=r.n(F);const D=n.a.Router();D.post("/xls",c.requestHandler.call(null,async e=>{const t=e.body||{},r=new H;if(t.name){await r.loadTemplate(M.a.join("uploads/",t.name)),r.applyData(t);const e=await P()("1234567890abcdef",21);return await r.toFile(M.a.join("public/",`${e}.xlsx`)),{link:`${e}.xlsx`}}throw new u("Не указано имя шаблона")})),D.post("/html",c.requestHandler.call(null,async e=>{const t=e.body||{},r=new k;if(t.name){await r.loadTemplate(M.a.join("uploads/",t.name)),r.applyData(t);const e=await P()("1234567890abcdef",21);return await r.toFile(M.a.join("public/",`${e}.html`)),{link:`${e}.html`}}throw new u("Не указано имя шаблона")}));var L=D;const A=n()();A.use(o()({origin:"*",methods:"GET,PUT,POST,OPTIONS",allowedHeaders:"Content-Type,Authorization,X-Requested-With",preflightContinue:!0})),A.use(i.a.json({limit:"10mb",extended:!0})),A.use(n.a.static("public")),A.get("/",(e,t)=>{t.status(200).send("Test service!")}),A.use("/api/v1/health",m),A.use("/api/v1/upload",b),A.use("/api/v1/template",L);A.listen(14e3,()=>{console.log("Server listening on port: 14000")})}]);